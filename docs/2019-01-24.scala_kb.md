<!--
$theme: gaia
template: default
-->
<!-- page_number: true -->
<!-- $size: 16:9 -->
<!-- footer: 2019-01-24 Scalaé–¢è¥¿å‹‰å¼·ä¼š -->

# Scala / refined ã§
# \`å‹ã\`è¡¨æ˜ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°


---
## è‡ªå·±ç´¹ä»‹

- æ— å¤§ä»‹
	- ![40%](images/prof_image.png)
	- Twitter: @hayasshi_
	- GitHub: hayasshi
- Chatworkæ ªå¼ä¼šç¤¾
- Scala 2.9ç³»ã‹ã‚‰ä½¿ã„å§‹ã‚(2013å¹´é ƒ)
- å‹å¥½ãã€Akkaå¥½ã


---
# è¡¨æ˜ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°


---
## è¡¨æ˜ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã¨ã¯

å…¥åŠ›ã‚„çµæœãªã©ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦æƒ³å®šå¤–ã®å€¤ã®å ´åˆã«ã¯å¼¾ãã“ã¨ã§
å…¨ä½“ã®å‹•ä½œã‚’æ­£å¸¸ã«ä¿ã¤

é˜²å¾¡çš„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®ã‚„ã‚Šæ–¹ã®ä¸€ã¤

`assert`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã¤ã‹ã£ã¦æ¤œæŸ»ã™ã‚‹ã“ã¨ãŒå¤šã„


---
## Scalaã§ã®è¡¨æ˜ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°

```scala
val namePattern = "[A-Z][a-zA-Z0-9]{0,9}".r.pattern

case class User(id: Long, name: String, age: Int) {
  assert(id > 0)
  assert(namePattern.matcher(name).matches())
  assert(age >= 18)
  
  def changeName(name: String): User = {
    assert(namePattern.matcher(name).matches())
    this.copy(name = name)
  }
}
```


---
## Scalaã§ã®è¡¨æ˜ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°

```scala
val namePattern = "[A-Z][a-zA-Z0-9]{0,9}".r.pattern

case class UserId(value: Long) {
  assert(value > 0)
}
case class UserName(value: String) {
  assert(namePattern.matcher(value).matches())
}
case class UserAge(value: Int) {
  assert(value >= 18)
}

case class User(id: UserId, name: UserName, age: UserAge) {
  def changeName(name: UserName): User = {
    this.copy(name = name)
  }
}
```


---
## è¡¨æ˜ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®ãƒ¡ãƒªãƒƒãƒˆ

- `fail fast` æƒ³å®šå¤–ã®å…¥åŠ›ãŒã‚ã‚Œã°æ—©æœŸã«ã‚¨ãƒ©ãƒ¼ã‚’ã‚ã’ã‚‹ã“ã¨ã§
ãƒ—ãƒ­ã‚°ãƒ©ãƒ å…¨ä½“ã®å‹•ä½œã‚’ä¿è­·ã™ã‚‹
- `documentation` è¡¨æ˜ã®ã‚³ãƒ¼ãƒ‰ã§ä½•ã‚’æ±‚ã‚ã¦ã„ã‚‹ã‹ãŒæ˜ç¤ºã•ã‚Œ
èª­ã¿æ‰‹ãŒç†è§£ã—ã‚„ã™ããªã‚‹(ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¿ƒé€²ã™ã‚‹)


---
## å®Ÿè¡Œæ™‚ã«æ¤œçŸ¥ã‹ã
## åˆ¶ç´„ã‚’èª²ã—ã¦ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«æ¤œçŸ¥ã§ãã‚Œã°ãªã


---
# refined


---
## refinedã¨ã¯

- [fthomas/refined](https://github.com/fthomas/refined)
- **refinement type** = ç¯©(ãµã‚‹ã„)å‹
	- å‹ + è¿°èª
	- å‹ã«è¿°èªã§ã¨ã‚Šå¾—ã‚‹å€¤ã®ã¿ã¨ã„ã†åˆ¶é™ãŒã§ãã‚‹

[Scalaé–¢è¥¿å‹‰å¼·ä¼š - Summitç›´å‰ã‚¹ãƒšã‚·ãƒ£ãƒ«](https://connpass.com/event/103702/) ã«ã¦
[@rider_yi](https://twitter.com/rider_yi) ã•ã‚“ãŒç´¹ä»‹ã•ã‚Œã¦ãŠã‚Šã€ã€Œã“ã‚Œã™ã’ãƒ¼ï¼ã€ã¨æ€ã£ã¦
ä»Šå›ã¨ã‚Šã‚ã’ã¦ã¿ã¾ã—ãŸã€‚

[refinedã§å®‰å…¨ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã](https://rider-yi.github.io/2018-10-24-refined/)


---
## refined

```scala
import eu.timepit.refined._
import eu.timepit.refined.api.Refined
import eu.timepit.refined.numeric._
import eu.timepit.refined.string._
import eu.timepit.refined.collection._
import eu.timepit.refined.auto._
```

```scala
scala> val naturalNumber: Int Refined Positive = 1
naturalNumber: Refined[Int,Positive] = 1

scala> val naturalNumber: Int Refined Positive = 0
<console>:24: error: Predicate failed: (0 > 0).
       val naturalNumber: Int Refined Positive = 0
```
â€»ã¿ã‚„ã™ãã—ã¦ã„ã¾ã™

---
## refined

```scala
scala> type NonEmptyString = String Refined NonEmpty

scala> val nonEmptyString: NonEmptyString = "foobar"
nonEmptyString: NonEmptyString = foobar

scala> val nonEmptyString: NonEmptyString = ""
<console>:28: error: Predicate isEmpty() did not fail.
       val nonEmptyString: NonEmptyString = ""

scala> type NickNameType =
         String Refined MatchesRegex[W.`"[a-zA-Z0-9]{3,10}"`.T]

scala> val nickName: NickNameType = "hayasshi"
nickName: NickNameType = hayasshi

scala> val nickName: NickNameType = "ã¯ã‚„ã—"
<console>:28: error: Predicate failed: "ã¯ã‚„ã—".matches("[a-zA-Z0-9]{3,10}").
       val nickName: NickNameType = "ã¯ã‚„ã—"
```


---
## refined

```scala
scala> val x = "hayasshi"
x: String = hayasshi                                                                                    ^

scala> refineV[MatchesRegex[W.`"[a-zA-Z0-9]{3,10}"`.T]](x)
res0: Either[String,Refined[String,MatchesRegex[String("[a-zA-Z0-9]{3,10}")]]]
        = Right(hayasshi)

scala> val x = "ã¯ã‚„ã—"
x: String = ã¯ã‚„ã—

scala> refineV[MatchesRegex[W.`"[a-zA-Z0-9]{3,10}"`.T]](x)
res1: Either[String,Refined[String,MatchesRegex[String("[a-zA-Z0-9]{3,10}")]]]
        = Left(Predicate failed: "ã¯ã‚„ã—".matches("[a-zA-Z0-9]{3,10}").)

```
â€»ã¿ã‚„ã™ãã—ã¦ã„ã¾ã™


---
## refinedã§è¡¨æ˜ã—ã¦ã¿ã‚‹

```scala
type UserIdType   = Long Refined Positive
type UserNameType = String Refined MatchesRegex[W.`"[A-Z][a-zA-Z0-9]{0,9}"`.T]
type UserAgeType  = Int Refined GreaterEqual[W.`18`.T]
```

```scala
case class UserId(value: UserIdType)
case class UserName(value: UserNameType)
case class UserAge(value: UserAgeType)

case class User(id: UserId, name: UserName, age: UserAge) {
  def changeName(name: UserName): User = {
    this.copy(name = name)
  }
}
```

`assert` ãŒãªããªã‚Šã‚³ãƒ¼ãƒ‰ãŒã‚¹ãƒƒã‚­ãƒªï¼


---
## refinedã§è¡¨æ˜ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã™ã‚‹ãƒ¡ãƒªãƒƒãƒˆ

- è¡¨ç¾å¯èƒ½ãªç¯„å›²ã§ `assert` ã‚’ä½¿ã‚ãªãã¦è‰¯ã„ãŸã‚ã‚³ãƒ¼ãƒ‰ãŒã‚¹ãƒªãƒ ã«
- ã‚·ã‚°ãƒãƒãƒ£ãƒ¬ãƒ™ãƒ«ã§å¼•ãç¶šããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®åŠ¹æœãŒã‚ã‚‹
- å¤‰æ•°ã‚’æ¸¡ã™å ´åˆã¯ `refineV[Predicate].apply` ã‚’åˆ©ç”¨ã—ã¦
`Either[String, T Refined Predicate]` ã‚’å–å¾—ã—ãƒã‚§ãƒƒã‚¯ã‚’å¼·åˆ¶ã™ã‚‹
- å„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã®çµ±åˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚‚æ§˜ã€…ãªã‚«ãƒ†ã‚´ãƒªã§ã‚ã‚‹
	- [refined#external-modules](https://github.com/fthomas/refined#external-modules)
	- Jsonã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰/ãƒ‡ã‚³ãƒ¼ãƒ‰ã€DBã‚¢ã‚¯ã‚»ã‚¹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãªã©
	- è‡ªåˆ†ã§å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å¯¾ã—ã¦ `refineV` ã›ãšã¨ã‚‚ `Either[E, T]` ãªã©ã§å–å¾—ã§ãã‚‹

---
## refinedã®ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

---
## ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒé…ããªã‚‹

refined ã¯ãƒã‚¯ãƒ­ã‚„ `implicit` ã‚’å¤šãä½¿ã£ã¦ã„ã‚‹ãŸã‚
ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒé•·ããªã‚‹

ä»Šå¾Œã® Scala è‡ªä½“ã®é€²åŒ–ã§ã©ã†ã«ã‹ãªã‚‹å¯èƒ½æ€§ã‚‚ï¼Ÿ


---
## å®Ÿè¡Œé€Ÿåº¦

#### ãƒªãƒ†ãƒ©ãƒ«

ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«ã™ã¹ã¦è§£æ±ºã•ã‚Œå®Ÿè¡Œæ™‚ã«ã¯ãƒªãƒ†ãƒ©ãƒ«ã‚’æ‰±ã†ã®ã¨åŒã˜å½¢ã¨ãªã‚‹ãŸã‚é€Ÿåº¦åŠ£åŒ–ãŒãªã„ ğŸ‰


---
## å®Ÿè¡Œé€Ÿåº¦

#### å¤‰æ•°

[sbt-jmh](https://github.com/ktoso/sbt-jmh)ã‚’ã¤ã‹ã£ã¦ç°¡æ˜“ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’å®Ÿæ–½ ([ã‚³ãƒ¼ãƒ‰](https://github.com/hayasshi/refined-sample))


---
## å®Ÿè¡Œé€Ÿåº¦

#### å¤‰æ•°

[sbt-jmh](https://github.com/ktoso/sbt-jmh)ã‚’ã¤ã‹ã£ã¦ç°¡æ˜“ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’å®Ÿæ–½ ([ã‚³ãƒ¼ãƒ‰](https://github.com/hayasshi/refined-sample))

```
sbt clean "jmh:run -i 10 -wi 10 -f1 -t1"
```

```
[info] Benchmark                      Mode  Cnt    Score   Error  Units
[info] Main.runCreateAssertObjects   thrpt   10  867.783 Â± 6.132  ops/s
[info] Main.runCreateRefinedObjects  thrpt   10  229.468 Â± 9.618  ops/s
```

**4å€**ãã‚‰ã„é…ã„ ğŸ˜‡


---
## å®Ÿè¡Œé€Ÿåº¦

Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã„ã†æ–‡è„ˆã§ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚„ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã€DBã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã»ã¨ã‚“ã©ã§ã€
åŸºæœ¬çš„ã«ã¯ **å¤‰æ•°** ã‚’æ‰±ã†ã“ã¨ã«ãªã‚‹

ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å‡¦ç†ã§ä½¿ã†ã®ã¯å³ã—ã„ã‹ã‚‚ã—ã‚Œãªã„...


---
## refinedã®æ´»ç”¨ã‚’è€ƒãˆã¦ã¿ãŸ(ææ¡ˆ)

æœ€è¿‘ã‚³ãƒ³ãƒ†ãƒŠå…¨ç››ã§ yaml ã‚’æ›¸ãã“ã¨ãŒå¤šã„

json <=> yaml ã¯å¤‰æ›ã§ãã‚‹ã®ã§ Scala ã§ json ç”Ÿæˆã™ã‚‹ãƒ„ãƒ¼ãƒ«ãªã©ã§
å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆ¶ç´„ã«ã¤ã‹ãˆãªã„ã‹

```scala
case class KubernetesManifest(
  kind: ResourceType.Pod,
  metadataName: String Refined NonEmpty Refined MaxSize[W.`24`.T],
  ...
  clusterIp: String Refined IPv4,
)
```


---
## ã¾ã¨ã‚

- refined ã‚’ä½¿ã†ã“ã¨ã§å‹ã‚’ã¤ã‹ã£ã¦è¡¨æ˜ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã§ãã‚‹
- refined ã®å®Ÿè¡Œã¯é…ãã†ã«è¦‹ãˆã‚‹...
- å®Ÿè¡Œé€Ÿåº¦ãŒãã“ã¾ã§æ±‚ã‚ã‚‰ã‚Œãªã„ä½•ã‹ã«ä½¿ãŠã†

#### Scala è¨€èªè‡ªä½“å«ã‚ä»Šå¾Œã®é€²åŒ–ã«æœŸå¾…


---
## å‚è€ƒ/å¼•ç”¨

- [PHP7 ã§å …ç‰¢ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã - ä¾‹å¤–å‡¦ç†ã€è¡¨æ˜ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã€å¥‘ç´„ã«ã‚ˆã‚‹è¨­è¨ˆ / PHP Conference 2016](https://speakerdeck.com/twada/php-conference-2016?slide=68)
- [refinedã§å®‰å…¨ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã](https://rider-yi.github.io/2018-10-24-refined/)
- [fthomas/refined](https://github.com/fthomas/refined)
